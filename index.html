<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地獄級蹲起監控系統</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 40px; }
    h1 { font-size: 2rem; }
    label, input { font-size: 1.2rem; margin: 5px; }
    button { font-size: 1.3rem; padding: 10px 20px; margin-top: 20px; }
    #status, #warning { margin-top: 20px; font-size: 1.3rem; }
    #warning { color: red; }
    #count, #time { font-size: 2.5rem; margin: 10px; }
    #version { margin-top: 30px; font-size: 1rem; color: #888; }
  </style>
</head>
<body>
  <h1>地獄級蹲起監控系統</h1>

  <div>
    <label>設定目標次數：</label>
    <input type="number" id="inputCount" value="20">
  </div>
  <div>
    <label>設定秒數限制：</label>
    <input type="number" id="inputTime" value="60">
  </div>
  <button onclick="prepareAudioThenStart()">開始任務</button>

  <div id="status">請設定任務後開始</div>
  <div>目前次數：<span id="count">0</span></div>
  <div>剩餘時間：<span id="time">-</span> 秒</div>
  <div id="warning"></div>

  <div id="version">版本 1.2.3</div>

  <script>
    let count = 0, target = 20, timeLimit = 60;
    let isGoingDown = false;
    let startTime, lastMoveTime;
    let interval, idleCheck;
    let idleLimit = 5;
    let idleWarnings = 0;
    let audioEnabled = false;
    const speech = window.speechSynthesis;

    function prepareAudioThenStart() {
      const dummy = new SpeechSynthesisUtterance('語音啟動');
      dummy.lang = 'zh-TW';
      let started = false;

      const launch = () => {
        if (!started) {
          started = true;
          audioEnabled = true;
          start();
        }
      };

      dummy.onend = launch;
      setTimeout(launch, 2000);
      speech.speak(dummy);
    }

    async function start() {
      if (
        typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function'
      ) {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== 'granted') {
          alert('請授權動作感測器才能開始');
          return;
        }
      }

      target = parseInt(document.getElementById('inputCount').value);
      timeLimit = parseInt(document.getElementById('inputTime').value);
      if (target <= 0 || timeLimit <= 0) {
        alert('請輸入有效數值');
        return;
      }

      count = 0;
      idleWarnings = 0;
      document.getElementById('count').textContent = count;
      document.getElementById('time').textContent = timeLimit;
      document.getElementById('status').textContent = '任務開始！';
      document.getElementById('warning').textContent = '';

      setTimeout(() => {
        initTimersAndMotion();
      }, 500);
    }

    function initTimersAndMotion() {
      startTime = Date.now();
      lastMoveTime = Date.now();

      interval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remain = timeLimit - elapsed;
        document.getElementById('time').textContent = remain;
        if (remain <= 0) {
          endTask();
        }
      }, 1000);

      idleCheck = setInterval(() => {
        if ((Date.now() - lastMoveTime) / 1000 > idleLimit) {
          idleWarnings++;
          speak('不要偷懶！繼續蹲起！');
          document.getElementById('warning').textContent = '⚠️ 檢測到你太久沒動作';
        } else {
          document.getElementById('warning').textContent = '';
        }
      }, 1000);

      window.addEventListener('devicemotion', handleMotion);
    }

    function handleMotion(e) {
      const totalAccel = Math.sqrt(
        e.accelerationIncludingGravity.x ** 2 +
        e.accelerationIncludingGravity.y ** 2 +
        e.accelerationIncludingGravity.z ** 2
      );
      if (totalAccel > 14 && !isGoingDown) {
        isGoingDown = true;
      } else if (totalAccel < 11 && isGoingDown) {
        isGoingDown = false;
        count++;
        lastMoveTime = Date.now();
        document.getElementById('count').textContent = count;
        speak(count.toString());
        if (count >= target) endTask(true);
      }
    }

    function endTask(success = false) {
      clearInterval(interval);
      clearInterval(idleCheck);
      window.removeEventListener('devicemotion', handleMotion);

      if (success || count >= target) {
        document.getElementById('status').textContent = `✅ 任務完成！總共 ${count} 下`;
        speak(`任務完成。總共完成 ${count} 下。`);
      } else {
        const now = Date.now();
        const overtimeSeconds = Math.floor((now - startTime) / 1000) - timeLimit;
        const shortfall = target - count;
        const punishment = shortfall + idleWarnings + Math.max(0, overtimeSeconds);

        document.getElementById('status').textContent = `❌ 未完成，補罰 ${punishment} 下（缺${shortfall} + 偷懶${idleWarnings} + 超時${overtimeSeconds}）`;
        speak(`時間到。你只做了 ${count} 下，請補罰 ${punishment} 下。`);
        setTimeout(() => restartPunishment(punishment), 3000);
      }
    }

    function restartPunishment(punishTarget) {
      count = 0;
      document.getElementById('count').textContent = count;
      document.getElementById('status').textContent = `補罰開始，請完成 ${punishTarget} 下！`;
      startTime = Date.now();
      lastMoveTime = Date.now();
      document.getElementById('time').textContent = '∞';

      idleCheck = setInterval(() => {
        if ((Date.now() - lastMoveTime) / 1000 > idleLimit) {
          speak('補罰中偷懶是不行的！');
          document.getElementById('warning').textContent = '⚠️ 偷懶警告！';
        } else {
          document.getElementById('warning').textContent = '';
        }
      }, 1000);

      window.addEventListener('devicemotion', function punishMotion(e) {
        const totalAccel = Math.sqrt(
          e.accelerationIncludingGravity.x ** 2 +
          e.accelerationIncludingGravity.y ** 2 +
          e.accelerationIncludingGravity.z ** 2
        );
        if (totalAccel > 14 && !isGoingDown) {
          isGoingDown = true;
        } else if (totalAccel < 11 && isGoingDown) {
          isGoingDown = false;
          count++;
          lastMoveTime = Date.now();
          document.getElementById('count').textContent = count;
          speak(count.toString());

          if (count >= punishTarget) {
            clearInterval(idleCheck);
            window.removeEventListener('devicemotion', punishMotion);
            document.getElementById('status').textContent = `✅ 補罰完成！${count} 下`;
            speak(`補罰完成，共 ${count} 下。`);
          }
        }
      });
    }

    function speak(text) {
      return new Promise((resolve) => {
        if (!audioEnabled) return resolve();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.onend = resolve;
        speech.speak(u);
      });
    }
  </script>
</body>
</html>
