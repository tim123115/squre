<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è¹²èµ·ä»»å‹™ + æ‡²ç½°ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    h1 { font-size: 2rem; }
    #status { font-size: 1.3rem; margin: 20px; }
    #count, #time { font-size: 2.5rem; }
    #warning { color: red; font-size: 1.2rem; margin-top: 10px; }
    button { font-size: 1.5rem; padding: 10px 20px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>è¹²èµ·ä»»å‹™ + æ‡²ç½°ç³»çµ±</h1>
  <div id="status">è«‹æŒ‰é–‹å§‹æˆæ¬Šæ„Ÿæ¸¬å™¨</div>
  <div>ç›®æ¨™æ¬¡æ•¸ï¼š<strong id="goal">20</strong></div>
  <div>ç›®å‰æ¬¡æ•¸ï¼š<span id="count">0</span></div>
  <div>å‰©é¤˜æ™‚é–“ï¼š<span id="time">60</span> ç§’</div>
  <div id="warning"></div>
  <button onclick="start()">é–‹å§‹</button>

  <script>
    const targetCount = 20;
    const punishmentCount = 10;
    const timeLimit = 60; // ç§’
    const idleLimit = 5;  // æœ€é•·å·æ‡¶ç§’æ•¸

    let count = 0;
    let isGoingDown = false;
    let started = false;
    let startTime;
    let lastMoveTime;
    let interval;
    let idleCheckInterval;

    async function requestPermissionIfNeeded() {
      if (
        typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        try {
          const response = await DeviceMotionEvent.requestPermission();
          if (response === "granted") {
            return true;
          } else {
            alert("âŒ è«‹æˆæ¬Šæ„Ÿæ¸¬å™¨æ‰èƒ½é–‹å§‹è¹²èµ·");
            return false;
          }
        } catch (e) {
          alert("âŒ è¦æ±‚æ¬Šé™éŒ¯èª¤ï¼š" + e);
          return false;
        }
      } else {
        return true; // é iOSï¼Œç„¡éœ€æˆæ¬Š
      }
    }

    async function start() {
      const ok = await requestPermissionIfNeeded();
      if (!ok) return;

      count = 0;
      isGoingDown = false;
      started = true;
      startTime = Date.now();
      lastMoveTime = Date.now();

      document.getElementById("count").textContent = count;
      document.getElementById("goal").textContent = targetCount;
      document.getElementById("time").textContent = timeLimit;
      document.getElementById("status").textContent = "ä»»å‹™é–‹å§‹ï¼";
      document.getElementById("warning").textContent = "";

      interval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timeLimit - elapsed;
        document.getElementById("time").textContent = remaining;

        if (remaining <= 0) {
          endTask();
        }
      }, 1000);

      idleCheckInterval = setInterval(() => {
        const now = Date.now();
        if ((now - lastMoveTime) / 1000 > idleLimit) {
          document.getElementById("warning").textContent = "âš ï¸ å¤ªä¹…æ²’å‹•ä½œäº†ï¼Œå¿«ç¹¼çºŒè¹²èµ·ï¼";
        } else {
          document.getElementById("warning").textContent = "";
        }
      }, 1000);

      window.addEventListener("devicemotion", handleMotion);
    }

    function handleMotion(event) {
      const z = event.accelerationIncludingGravity.z;

      if (z < -5 && !isGoingDown) {
        isGoingDown = true;
      } else if (z > 5 && isGoingDown) {
        isGoingDown = false;
        count++;
        lastMoveTime = Date.now();
        document.getElementById("count").textContent = count;

        if (count >= targetCount) {
          endTask(true);
        }
      }
    }

    function endTask(success = false) {
      clearInterval(interval);
      clearInterval(idleCheckInterval);
      window.removeEventListener("devicemotion", handleMotion);

      if (success) {
        document.getElementById("status").textContent = `âœ… ä»»å‹™å®Œæˆï¼ç¸½å…± ${count} ä¸‹`;
      } else {
        if (count >= targetCount) {
          document.getElementById("status").textContent = `âœ… æ™‚é–“åˆ°ä½†ä½ å‰›å¥½å®Œæˆ ${count} ä¸‹`;
        } else {
          document.getElementById("status").textContent = `âŒ æ™‚é–“åˆ°åªåšäº† ${count} ä¸‹ï¼Œè«‹è£œç½° ${punishmentCount} ä¸‹`;
          document.getElementById("warning").textContent = "ğŸ” è£œç½°éšæ®µé–‹å§‹ï¼";
          setTimeout(() => {
            restartPunishment();
          }, 3000);
        }
      }
    }

    function restartPunishment() {
      document.getElementById("status").textContent = "è£œç½°éšæ®µé–‹å§‹ï¼";
      count = 0;
      startTime = Date.now();
      lastMoveTime = Date.now();
      document.getElementById("count").textContent = count;
      document.getElementById("goal").textContent = punishmentCount;
      document.getElementById("time").textContent = "âˆ";

      idleCheckInterval = setInterval(() => {
        const now = Date.now();
        if ((now - lastMoveTime) / 1000 > idleLimit) {
          document.getElementById("warning").textContent = "âš ï¸ è£œç½°ä¸­å·æ‡¶ï¼Ÿå¿«å‹•èµ·ä¾†ï¼";
        } else {
          document.getElementById("warning").textContent = "";
        }
      }, 1000);

      window.addEventListener("devicemotion", function punishMotion(event) {
        const z = event.accelerationIncludingGravity.z;
        if (z < -5 && !isGoingDown) {
          isGoingDown = true;
        } else if (z > 5 && isGoingDown) {
          isGoingDown = false;
          count++;
          lastMoveTime = Date.now();
          document.getElementById("count").textContent = count;

          if (count >= punishmentCount) {
            clearInterval(idleCheckInterval);
            window.removeEventListener("devicemotion", punishMotion);
            document.getElementById("status").textContent = `âœ… è£œç½°å®Œæˆï¼å…± ${count} ä¸‹`;
            document.getElementById("warning").textContent = "";
          }
        }
      });
    }
  </script>
</body>
</html>
