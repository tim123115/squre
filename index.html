<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>蹲起任務懲罰系統</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 50px; }
    h1 { font-size: 2rem; }
    #status { font-size: 1.3rem; margin: 20px; }
    #count, #time { font-size: 2.5rem; }
    #warning { color: red; font-size: 1.2rem; margin-top: 10px; }
    button { font-size: 1.5rem; padding: 10px 20px; margin-top: 30px; }
  </style>
</head>
<body>
  <h1>蹲起任務 + 懲罰系統</h1>
  <div id="status">請按開始</div>
  <div>目標次數：<strong id="goal">20</strong></div>
  <div>目前次數：<span id="count">0</span></div>
  <div>剩餘時間：<span id="time">60</span> 秒</div>
  <div id="warning"></div>
  <button onclick="start()">開始</button>

  <script>
    const targetCount = 20;       // 任務次數
    const punishmentCount = 10;   // 補罰次數
    const timeLimit = 60;         // 秒
    const idleLimit = 5;          // 最長偷懶秒數

    let count = 0;
    let isGoingDown = false;
    let started = false;
    let startTime;
    let lastMoveTime;
    let interval;
    let idleCheckInterval;

    function start() {
      if (!window.DeviceMotionEvent) {
        alert("你的裝置不支援動作感測器");
        return;
      }

      count = 0;
      isGoingDown = false;
      started = true;
      startTime = Date.now();
      lastMoveTime = Date.now();

      document.getElementById("count").textContent = count;
      document.getElementById("goal").textContent = targetCount;
      document.getElementById("time").textContent = timeLimit;
      document.getElementById("status").textContent = "任務開始！";
      document.getElementById("warning").textContent = "";

      // 倒數計時器
      interval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timeLimit - elapsed;
        document.getElementById("time").textContent = remaining;

        if (remaining <= 0) {
          endTask();
        }
      }, 1000);

      // 偷懶檢查
      idleCheckInterval = setInterval(() => {
        const now = Date.now();
        if ((now - lastMoveTime) / 1000 > idleLimit) {
          document.getElementById("warning").textContent = "⚠️ 你太久沒動作了，快繼續蹲起！";
        } else {
          document.getElementById("warning").textContent = "";
        }
      }, 1000);

      window.addEventListener("devicemotion", handleMotion);
    }

    function handleMotion(event) {
      const z = event.accelerationIncludingGravity.z;

      if (z < -5 && !isGoingDown) {
        isGoingDown = true;
      } else if (z > 5 && isGoingDown) {
        isGoingDown = false;
        count++;
        lastMoveTime = Date.now();
        document.getElementById("count").textContent = count;

        if (count >= targetCount) {
          endTask(true);
        }
      }
    }

    function endTask(success = false) {
      clearInterval(interval);
      clearInterval(idleCheckInterval);
      window.removeEventListener("devicemotion", handleMotion);

      if (success) {
        document.getElementById("status").textContent = `✅ 任務完成！總共 ${count} 下`;
      } else {
        if (count >= targetCount) {
          document.getElementById("status").textContent = `✅ 時間到但你剛好完成 ${count} 下`;
        } else {
          document.getElementById("status").textContent =
            `❌ 時間到！你只做了 ${count} 下，請補罰 ${punishmentCount} 下`;
          document.getElementById("warning").textContent =
            "🔁 重新開始補罰階段！";
          setTimeout(() => {
            restartPunishment();
          }, 3000);
        }
      }
    }

    function restartPunishment() {
      document.getElementById("status").textContent = "補罰階段開始！";
      count = 0;
      startTime = Date.now();
      lastMoveTime = Date.now();
      document.getElementById("count").textContent = count;
      document.getElementById("goal").textContent = punishmentCount;
      document.getElementById("time").textContent = "∞";

      // 不倒數，只檢查是否完成補罰
      idleCheckInterval = setInterval(() => {
        const now = Date.now();
        if ((now - lastMoveTime) / 1000 > idleLimit) {
          document.getElementById("warning").textContent = "⚠️ 補罰中偷懶？快動起來！";
        } else {
          document.getElementById("warning").textContent = "";
        }
      }, 1000);

      window.addEventListener("devicemotion", function punishMotion(event) {
        const z = event.accelerationIncludingGravity.z;
        if (z < -5 && !isGoingDown) {
          isGoingDown = true;
        } else if (z > 5 && isGoingDown) {
          isGoingDown = false;
          count++;
          lastMoveTime = Date.now();
          document.getElementById("count").textContent = count;

          if (count >= punishmentCount) {
            clearInterval(idleCheckInterval);
            window.removeEventListener("devicemotion", punishMotion);
            document.getElementById("status").textContent = `✅ 補罰完成！共 ${count} 下`;
            document.getElementById("warning").textContent = "";
          }
        }
      });
    }
  </script>
</body>
</html>
